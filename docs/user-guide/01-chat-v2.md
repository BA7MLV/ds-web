# 智能对话

## 概述

智能对话是 Deep Student 的核心功能模块，基于 **Chat V2** 引擎构建。它不仅提供强大的 AI 对话能力，还通过 **Block（块）** 架构实现了丰富的交互体验——思维链折叠、工具调用可视化、多模态混排，以及完整的 Agent 任务执行流程。

### 主要特性

- **Block 交互架构**：消息由独立的功能块组成，每种块类型有独立的渲染逻辑和交互能力
- **会话分组管理**：支持自定义分组，对话按项目或主题整理，支持拖拽排序
- **对话控制面板**：实时调整温度、Top-P、最大 Token、RAG 参数等，按会话级覆盖
- **Skills 技能系统**：按需加载专业技能，实现能力渐进式披露，减少无关工具占用 Token
- **VFS 知识库集成**：深度集成虚拟文件系统，在对话中直接引用笔记、教材、题目集
- **推理模式**：支持深度思考模型，完整展示推理过程
- **Agent 任务执行**：支持 Attempt Completion 自动判断任务完成，以及多 Agent 工作区协作

---

## 会话管理

### 创建会话

**普通对话会话**：
- 点击对话侧边栏顶部的 **"+"** 按钮，或使用 `Cmd/Ctrl + N`
- 若当前会话为空（无消息），不会创建新的空白会话，避免重复

**分析模式会话**：
- 专为图片 OCR 和题目识别设计
- 通过命令面板执行**「新建题目分析」**（快捷键 `Cmd/Ctrl + Shift + A`）
- 选择一张或多张图片（支持 PNG/JPG/JPEG/GIF/WEBP/BMP/SVG/HEIC/HEIF）
- 创建后图片自动作为初始上下文加载，AI 可直接对图片内容进行识别和分析

### 切换与搜索

- 左侧对话列表按时间分组：今天 / 昨天 / 过去 7 天 / 过去 30 天 / 更早
- 列表顶部搜索框可按标题实时过滤会话
- 应用启动时自动恢复上次打开的会话

### 会话浏览模式（Browser View）

点击左侧会话列表上方的「**所有对话**」按钮（格状图标），切换为**全宽浏览模式**：
- 以卡片网格形式展示全部会话
- 显示会话标题、所属分组、最后更新时间
- 方便批量管理和查找历史对话

### 对话分组

对话可以按项目或主题整理进分组：

1. 点击会话列表中「分组」标题行右侧的 **"+"** 按钮（悬停时显示）
2. 设置分组名称、图标（预设图标或 Emoji）、颜色
3. 将会话拖拽到分组中
4. 分组可折叠/展开，可重新排序（拖拽分组标题行）

分组图标支持两种格式：
- **Emoji**：直接显示在分组名称前（如 📚、🔬）
- **预设 Lucide 图标**：内置的线性图标集

**分组高级配置**：

除了基础的名称、图标和颜色外，每个分组还支持以下高级配置：

| 配置项 | 说明 |
|--------|------|
| **系统提示词** | 为分组设置独立的系统提示词，组内所有新会话自动使用 |
| **默认技能** | 分组默认激活的技能列表，创建组内新会话时自动激活 |
| **固定资源** | 分组内固定引用的学习资源，组内会话自动加载为上下文 |
| **关联工作区** | 将分组关联到一个多 Agent 工作区 |

### 回收站

删除会话时采用软删除策略（先移入回收站，不立即永久删除）：

1. 悬停在会话上，点击 **删除** 按钮，会话进入回收站
2. 点击侧边栏中**「回收站」**按钮（垃圾桶图标，位于「所有对话」下方）查看已删除会话
3. 在回收站中可 **恢复** 会话（恢复后自动切换到该会话）或 **永久删除**
4. **清空回收站** 按钮可一次性永久删除所有已删除会话

---

## 核心交互体验

### Block 消息流

Chat V2 的每条 AI 回复由多个功能块组成，不同块类型有不同的交互方式：

| 块类型 | 触发条件 | 交互能力 |
|--------|----------|----------|
| **思维链块** (Thinking) | 推理模型生成中间思考 | 默认折叠，点击展开查看完整推理过程 |
| **内容块** (Content) | AI 文本回复 | Markdown 渲染、代码高亮 |
| **工具调用块** (MCP Tool) | AI 调用 MCP 工具 | 展示工具名称、输入参数、执行状态和结果；论文保存工具（paper_save）在此块内展示下载进度 |
| **RAG 检索块** | 知识检索技能查询本地文档 | 展示检索到的文档片段、相似度分数 |
| **记忆检索块** (Memory) | 记忆检索 | 展示召回的长期记忆条目 |
| **网络搜索块** | 联网搜索工具 | 展示搜索查询和结果摘要 |
| **学术搜索块** | 学术搜索技能（arXiv/OpenAlex） | 展示论文标题、作者、摘要、引用数 |
| **图像生成块** | 图像生成工具 | 展示生成图片，支持全屏预览和下载 |
| **Anki 卡片块** | ChatAnki 制卡技能 | 展示卡片预览、进度状态，支持编辑/导出/同步 |
| **模板预览块** | 模板设计工具 | 直接在聊天流中预览 Anki 卡片模板渲染效果 |
| **用户提问块** (Ask User) | AI 主动向用户确认偏好 | 3 个选项 + 自定义输入，**30 秒超时自动选推荐项** |
| **待办列表块** (Todo List) | todo 工具创建/更新任务 | 展示任务清单和完成进度 |
| **工作区状态块** | 多 Agent 协作工作区 | 展示工作区信息、各 Agent 状态和最新进度 |
| **睡眠等待块** (Sleep) | 主代理等待子代理完成 | 展示等待状态和倒计时，子代理完成后自动唤醒 |
| **子代理嵌入块** | 主代理启动子代理 | 展示子代理会话链接，可点击跳转查看子代理输出 |
| **子代理重试块** | 子代理任务失败 | 展示失败原因，支持重试操作 |
| **工具限制块** (Tool Limit) | 单轮工具调用达到上限 | 提示用户已达调用上限，提供"继续执行"按钮 |

### 推理模式（思维链）

1. 点击输入栏底部工具栏中的 **推理模式按钮**（原子图标）
2. 开启后图标高亮，AI 回复时优先生成思维链块
3. 思维链内容默认折叠，保持界面整洁，点击即可展开

> 推理模式需要模型支持思维链输出。当前支持的模型包括：DeepSeek-V3.2（混合推理）、QwQ-32B、Doubao Seed 2.0 系列、GLM-4.5/4.6/4.7/5、Claude Sonnet 4/Opus 4、Gemini 2.5+、Kimi K2.5、MiniMax M2 等。在模型配置中勾选"推理模型"能力即可激活。开启状态下温度参数的调整效果会受到模型推理逻辑影响。

### 上下文引用（VFS 集成）

将知识库中的资源引入对话：

1. 点击输入栏的 **资源库** 按钮（回形针图标）
2. 在弹出的资源浏览面板中浏览或搜索
3. 选中资源后点击 **添加到对话**，资源以标签形式显示在输入框上方
4. 发送消息时，AI 读取并参考这些资源内容

**右侧面板预览**：在对话中点击上下文引用标签，资源会在右侧面板内嵌打开（笔记、PDF、题目集等），无需离开聊天页面。

### 对话控制面板

点击左侧会话列表中的「**对话控制**」按钮（滑条图标，位于回收站下方），在左侧会话列表中展开对话控制面板。可按当前会话覆盖全局设置：

| 参数 | 范围 | 默认值 | 说明 |
|------|------|--------|------|
| **温度** | 0 ~ 2 | 0.7 | 控制输出随机性。越高越有创意，越低越确定 |
| **Top-P** | 0 ~ 1 | 0.9 | 核采样参数，控制输出多样性 |
| **频率惩罚** | -2 ~ 2 | 0 | 正值减少重复词汇的使用 |
| **存在惩罚** | -2 ~ 2 | 0 | 正值鼓励讨论新话题 |
| **最大输出** | 1024 ~ 128000 | 32768 | 控制 AI 回复的最大长度 |
| **上下文长度** | 2048 ~ 2M | 自动计算 | 限制输入到模型的历史上下文长度 |
| **检索条数 (Top-K)** | 1 ~ 50 | 10 | 知识检索时召回的最大文档片段数 |
| **启用重排序** | 开/关 | 开 | 对检索结果进行语义重排序，提升相关性 |

"自动计算"的上下文预算 = 模型上下文窗口 - 最大输出 Token，会随选择的模型自动更新。点击 **自动** 按钮可恢复为自动计算。

---

## 技能系统

Deep Student 采用 **Skills（技能）** 机制管理 AI 能力。工具不再全量加载，而是通过技能**按需注入**，减少无关工具占用上下文 Token。

### 激活方式

1. **UI 选择**：点击输入框下方的 **技能按钮**（闪电图标），勾选所需技能
2. **自动推荐**：在对话中描述需求，AI 可能主动建议激活相关技能

### 常用技能

| 技能 ID | 名称 | 用途 | 包含工具 |
|---------|------|------|----------|
| `tutor-mode` | 导师模式 | 苏格拉底式教学，引导思考而非直接给答案 | 无（纯指令型） |
| `chatanki` | ChatAnki 制卡 | 端到端制卡，支持 PDF/图片/截图/手写/Markdown | Anki 制卡工具 |
| `knowledge-retrieval` | 知识检索 | 查阅本地资料（RAG）和联网搜索 | 统一搜索、网络搜索 |
| `canvas-note` | 智能笔记 | 在对话中创建和编辑笔记 | 笔记读写工具 |
| `vfs-memory` | 记忆管理 | 存储和检索长期记忆 | 记忆读写工具 |
| `mindmap-tools` | 思维导图 | 创建和编辑知识导图 | 导图生成工具 |
| `literature-review` | 文献综述助手 | 系统化学术文献综述（搜索+笔记+报告） | 学术搜索、笔记、待办 |
| `research-mode` | 调研模式 | 深度调研，自动管理进度，生成调研报告 | 网络搜索、笔记、待办 |
| `deep-student` | 深度学者 | **默认开启**，主动回忆用户记忆，个性化回答 | 统一搜索、网络搜索、记忆读写、Ask User、资源浏览、导图工具、网页抓取、附件解析 |

> `deep-student` 是 Deep Student 的默认技能，每次对话开始时会主动搜索相关记忆，确保回答个性化。

详见 [技能系统](./07-skills.md)。

### MCP 工具支持

除内置技能，可在 **设置 → MCP 工具** 中连接外部 MCP 服务器，扩展 AI 的工具能力。外部工具同样通过激活相应技能按需加载。

---

## Agent 与多 Agent 协作

### 自动任务完成（Attempt Completion）

在 Agent 模式下处理复杂任务时（如"帮我调研这个课题并写报告"），AI 会连续执行多个步骤。内置的 `attempt_completion` 机制让 AI 在任务完成时自动收敛并输出总结结果。

- AI 判断任务完成后，主动调用 `attempt_completion` 并停止后续工具调用
- 可随时点击 **停止** 按钮中断 Agent 执行流程

### 多 Agent 工作区协作

部分高级技能（如文献综述、深度调研）支持 Workspace 多 Agent 模式：

- **主代理**负责任务分解和协调，可将子任务分派给**子代理**并行执行
- 对话中显示**工作区状态块**，实时展示各 Agent 状态、进度和最新消息
- 子代理嵌入块可点击跳转，查看对应子代理会话的完整输出
- 主代理可进入睡眠等待子代理完成，唤醒后汇总结果

---

## 消息操作

### 编辑与重试

- **编辑重发**：悬停在用户消息上，点击 **编辑** 图标，修改后重发，AI 基于新内容生成回复（会创建新的对话分支）
- **重试**：对 AI 回复不满意时，点击 **重试** 图标重新生成；支持切换模型单独重试，或多模型并行重试

### 多模型对比

1. 点击输入栏底部的 **模型选择按钮**
2. 勾选多个模型（如 DeepSeek-V3.2 + Claude Sonnet 4）
3. 发送消息，系统并行生成多个回复，并排展示

### 从此处分支

- 悬停在任意消息上，点击 **从此处分支** 图标
- 系统基于该消息之前的上下文创建一个新的分支会话
- 分支会话出现在对话列表顶部，可独立发展

### 其他消息操作

- **保存为笔记**：将 AI 回复保存到学习资源的笔记
- **导出为 Markdown**：将当前消息导出为 `.md` 文件
- **复制**：复制消息内容到剪贴板

---

## 快捷键

| 快捷键 | 功能 |
|--------|------|
| **Enter** | 发送消息 |
| **Shift + Enter** | 换行 |
| **Cmd/Ctrl + N** | 新建对话（仅在有消息的会话中） |
| **Cmd/Ctrl + Shift + A** | 新建题目分析（上传图片进行 OCR 识别） |
| **Cmd/Ctrl + K** | 打开命令面板 |
| **Cmd/Ctrl + Shift + T** | 切换明暗主题 |
| **Cmd/Ctrl + R** | 重新生成上一条 AI 回复 |
| **Cmd/Ctrl + .** | 停止 AI 生成 |

---

## 常见问题

### Q: 为什么我看不到 Anki 制卡工具？
A: 工具通过技能按需加载。请先激活 **ChatAnki 制卡** 技能，制卡工具会自动注入到当前对话中。

### Q: 为什么提示"请先配置对话模型"？
A: Chat V2 依赖**对话模型**配置。请前往 **设置 → 模型分配**，为**对话模型**选择一个可用的 AI 模型。

### Q: 思维链（Thinking）内容在哪里？
A: 支持推理的模型（如 DeepSeek-V3.2、QwQ-32B、Claude Sonnet 4、Gemini 2.5 等）的思考过程折叠在消息顶部的"思维链"块中，点击即可展开。需在模型配置中勾选"推理模型"能力。

### Q: 用户提问块（Ask User）超时会怎样？
A: 30 秒倒计时结束后，系统自动选择标记为"推荐"的选项，AI 继续执行流程。

### Q: 如何查看子代理的执行输出？
A: 点击对话中的**子代理嵌入块**，系统会切换到对应子代理的会话，查看其完整输出记录。

---

*最后更新：2026-02-27*
