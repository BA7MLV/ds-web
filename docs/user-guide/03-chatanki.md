# Anki 智能制卡

## 概述

Anki 智能制卡是 Deep Student 的核心功能，将学习材料高效转化为可复习的 Anki 记忆卡片。

**核心理念：Chat-First（对话即制卡）**

通过激活 **ChatAnki 制卡** 技能，在对话中直接完成从材料解析到卡片生成、导出的完整流程。无需填写表单，只需告诉 AI 你的学习目标。

侧边栏的 **"制卡任务"** 页面是制卡任务控制台，**"模板管理"** 页面负责卡片模板设计。

---

## 标准工作流

### 第一步：激活技能

在对话页面，点击技能按钮（闪电图标），激活 **ChatAnki 制卡** 技能。

> 只有激活了 ChatAnki 制卡技能，AI 才具备调用制卡引擎的权限。

### 第二步：提供材料

支持两种方式提供制卡材料：

**方式一：上传文件（推荐）**
- 点击输入栏附件按钮，上传 PDF、图片、截图、手写笔记、Word 文档等
- AI 自动解析文件内容后开始制卡

**方式二：粘贴文本**
- 直接将需要制卡的文本/Markdown 粘贴到输入框
- AI 读取文本内容后开始制卡

### 第三步：下达指令

告诉 AI 你的学习目标和偏好（例如："把这份 PDF 的核心概念做成填空卡，大约 20 张"）。

若指令中没有明确卡片数量和模板偏好，AI 会先用 **Ask User 块**确认关键偏好（如卡片数量、模板模式）。**30 秒**内未响应，系统自动选择推荐选项。

> 若没有提供任何学习材料（未上传文件、未粘贴内容），AI 必须先通过 Ask User 询问材料来源，不会直接开始制卡。

### 第四步：确认预览

制卡完成后，对话中出现 **Anki 卡片块**：
- 展示卡片正面、背面、标签、进度状态
- 显示 AnkiConnect 连接状态（是否可直接同步）
- 提供以下操作按钮

### 第五步：导出或同步

| 操作 | 说明 |
|------|------|
| **导出 APKG** | 导出为标准 Anki 包，手动导入 Anki |
| **导出 JSON** | 导出为 JSON 格式，方便二次处理 |
| **同步到 Anki** | 通过 AnkiConnect 一键推送到本地 Anki（需先配置） |

---

## 制卡参数说明

### 路由模式（自动选择）

系统根据材料类型自动选择最优路由，也可在指令中指定：

| 路由 | 说明 | 适用场景 |
|------|------|----------|
| `simple_text` | 纯文本处理 | Markdown/纯文本笔记 |
| `vlm_light` | 轻量多模态 | 含少量图表的 PDF |
| `vlm_full` | 完整多模态 | 图文密集的 PDF、手写扫描 |

### 模板选择模式

| 模式 | 说明 |
|------|------|
| `single` | 使用单个指定模板 |
| `multiple` | 使用多个指定模板（分批生成） |
| `all` | 使用全部已启用模板 |

### 卡片数量参考

| 材料量 | 建议张数 |
|--------|----------|
| 一两句话 | 3 ~ 5 张 |
| 一段话（100~500字） | 5 ~ 15 张 |
| 中等文本（500~2000字） | 15 ~ 30 张 |
| 长文档（>2000字） | 30 ~ 80 张 |

### 多资源批量制卡

对多个文件同时制卡：
- 在输入栏中引用多个资源（教材/笔记/图片）
- 或告诉 AI 要处理的资源 ID 列表
- AI 会合并所有资源内容后统一制卡

---

## 任务管理

### 制卡任务控制台

侧边栏的 **"制卡任务"** 页面展示所有制卡任务的实时状态：

- **进行中**：显示分段处理进度（已完成/总数）
- **已暂停**：可恢复继续
- **已完成**：可导出或同步
- **失败**：显示错误原因，可重试失败分段

### 控制制卡任务

在对话中或任务控制台中：

| 操作 | 对话指令 | 说明 |
|------|----------|------|
| 查询进度 | "进度如何？" | AI 调用 chatanki_status 返回统计 |
| 等待完成 | "等一下" / "好了吗" | AI 调用 chatanki_wait 轮询状态 |
| 暂停 | "暂停制卡" | AI 调用 chatanki_control（pause） |
| 恢复 | "继续制卡" | AI 调用 chatanki_control（resume） |
| 取消 | "取消制卡" | AI 调用 chatanki_control（cancel） |
| 重试 | "重试失败部分" | AI 调用 chatanki_control（retry） |

### 预分析材料

在正式制卡前，可让 AI 预估材料：
> "帮我预估一下这份 PDF 适合做多少张卡片"

AI 调用 `chatanki_analyze` 分析材料长度、词条密度，推荐路由和卡片数量。

---

## Template Designer（模板管理）

### 进入模板管理

点击侧边栏的 **"模板管理"** 图标直接进入。

### 主要功能

- **可视化编辑**：左侧编写 HTML/CSS，右侧实时预览效果
- **字段管理**：自定义卡片字段（如 Front、Back、Note、Audio）
- **AI 提取规则**：为每个字段配置 AI 提取指令
- **内置模板**：系统预置多种精美模板（如 "The Lab"、"Swiss Design"），可直接使用或 Fork 修改
- **设为默认**：ChatAnki 优先使用默认模板生成卡片

**AI 辅助设计**：激活 ChatAnki 制卡技能后，可让 AI 帮你编写 HTML/CSS，对话中直接预览和创建模板。

---

## 连接 Anki

配置 AnkiConnect 后可实现一键同步：

1. 打开 Anki 桌面端
2. 安装插件 **AnkiConnect**（代码：`2055492159`）
3. 在 Deep Student **制卡任务** 侧边栏中，点击 **AnkiConnect 设置** 检查连接状态

也可让 AI 检查：在对话中说"检查一下 AnkiConnect"，AI 调用 `chatanki_check_anki_connect` 返回连接状态。

---

## 常见问题

### Q: 找不到原来的"批量制卡"页面了？
A: 表单式制卡已废弃。直接在 Chat V2 中上传文件并发送指令，体验更流畅的 AI 驱动流程。在 **"制卡任务"** 侧边栏中查看生成进度。

### Q: 为什么 Chat 中无法制卡？
A: 请确认是否激活了 `chatanki` 技能。只有激活该技能，AI 才有权限调用制卡工具。

### Q: 图片卡片无法在 Anki 中显示？
A: 确保 AnkiConnect 配置正确，且允许媒体文件同步。Deep Student 自动处理图片的 Base64 编码和传输。

### Q: 如何修改已生成的卡片？
A: 在对话中告诉 AI 你想修改的内容（如"把第 3 张卡片的正面改为..."），AI 会更新对应卡片。也可在 Anki 卡片块中直接点击编辑。

### Q: chatanki_wait 超时了怎么办？
A: 不要直接判定失败。可以继续告诉 AI "再等等"，或者让 AI 调用 chatanki_status 查询分段统计，直到任务进入完成/失败/取消终态。

---

*最后更新：2026-02-21*
