# 数据管理与治理

## 概述

Deep Student 极其重视用户数据的安全与隐私。**数据治理 (Data Governance)** 模块是系统的数据中枢，负责统一管理所有数据的备份、恢复、同步、迁移和健康检查。

入口：**设置 -> 数据治理**

---

## 备份管理

Deep Student 采用先进的 **分层备份策略**，让你在数据安全和存储空间之间取得平衡。

### 分层备份策略 (Tiered Backup)

系统将数据划分为四个层级：

| 层级 | 内容 | 建议 |
|------|------|------|
| **核心数据 (P0)** | 聊天记录 (chat_v2.db)、虚拟文件系统 (vfs.db)、主数据库（含卡片/设置等） | 体积小，建议高频备份 |
| **重要数据 (P1)** | 包含 P0 + LLM 使用统计 (llm_usage.db)、笔记附件 (notes_assets/) | 建议每日备份 |
| **可重建数据 (P2)** | 包含 P0-P1 + 向量索引 (lance/)，可通过重新索引恢复 | 按需备份，丢失后可重建 |
| **大型资产 (P3)** | 包含 P0-P2 + 图片/文档/视频等媒体文件 | 体积大，建议定期导出或使用增量备份 |

### 执行备份

在数据治理面板中：
1. 选择 **"备份"** 标签页。
2. 勾选 **"使用分层备份"** 并选择需要备份的层级（不勾选则备份全部数据）。
3. 点击 **"导出备份"**，生成 ZIP 文件保存到本地。

### 自动备份

建议开启自动备份功能：
- 设置备份频率（如每 24 小时）。
- 设置保留策略（如保留最近 7 天 + 每周 1 份）。

---

## 云同步

支持基于 WebDAV 或 S3 的私有云同步，实现多端数据互通。

### 配置云存储
在 **设置 -> 数据治理** 中配置你的 WebDAV（如坚果云）或 S3（如 AWS, MinIO, 阿里云 OSS）服务信息。

### 同步机制
Deep Student 采用 **记录级增量同步**：
- **冲突检测**：当多端同时修改同一数据时，系统会触发冲突检测。
- **解决策略**：
    - **保留最新**：基于时间戳自动选择较新的数据（推荐）。
    - **保留本地**：以当前设备的数据为准。
    - **使用云端**：覆盖本地修改，以云端数据为准。
    - **手动处理**：暂不处理，稍后逐条手动解决。

在 **"同步"** 标签页可以查看待同步的变更数，并手动触发同步。

---

## 健康检查与审计

### 健康检查
系统内置了数据库健康检查工具。在 **"概览"** 标签页点击 **"运行健康检查"**，系统会扫描：
- 数据库文件完整性
- 外键约束一致性
- VFS 资源索引状态

若发现问题（如索引丢失），系统会提供修复建议或自动修复选项。

### 审计日志
所有敏感操作（备份、恢复、删除、同步）都会被记录。在 **"审计"** 标签页可以查看操作历史，追踪数据变更。

### 缓存管理

在 **"缓存"** 标签页可以查看和清理媒体缓存（如 PDF 渲染缓存、图片缓存等），释放磁盘空间。

---

## 数据迁移

### 从 V1 迁移

如果你是从 Deep Student 旧版本升级，系统会在**启动时自动检测并执行 Schema 升级迁移**。若检测到待执行迁移，会在界面提示重启应用。

> 旧版用户数据（如 `mistakes.db`、`chat_messages` 表）的手动迁移功能目前尚未集成到界面，如需迁移旧数据请联系支持。

### ZIP 导入导出
- **导出**：可以将指定层级的数据打包为标准 ZIP 文件，方便迁移到新设备。
- **导入**：支持从 ZIP 包完整恢复数据。

---

## 常见问题

### Q: 备份文件占用了太多空间怎么办？
A: 
1. 检查备份策略，避免对 P2/P3 层级进行过于频繁的全量备份。
2. 在备份列表中删除旧的备份文件。
3. 使用 "清理" 功能移除未引用的图片和缓存。

### Q: 同步时提示冲突怎么办？
A: 这是正常现象。点击 "解决冲突"，系统会列出冲突的数据项。通常选择 "保留最新" 即可，如果你确定某台设备的修改更重要，可以选择 "保留本地" 或 "使用云端"。

### Q: 为什么我看不到旧版的错题数据？
A: 旧版 "错题本" 已升级为 "题目集 (Question Bank)"。数据库 Schema 升级会在应用启动时自动执行，如启动时提示重启应用请按提示操作。若旧数据仍未出现，请联系技术支持。

---

*最后更新：2026-02-21*